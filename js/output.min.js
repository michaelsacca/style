function ModalViewModel(){var self=this;self.modalContainer=$(".modalContainer"),self.activeModal=ko.mapping.fromJS({caption:{text:""},comments:{data:[]}}),self.active=ko.observable(!1),self.addNewComment=function(input){var $input=$(input);InstaAPI.sendComment(this.id(),$input.val(),function(res){res&&!res.error&&(self.activeModal.comments.data.push(res.data),$(".comments").scrollTop($(".comments")[0].scrollHeight),$input.val(""))})}}function AppViewModels(){var self=this;self.modalContainer=$(".modalContainer"),self.feedItems=ko.observableArray([]),self.modal=ko.observable(new ModalViewModel),self.userFeedItems=ko.observableArray([]),self.setActiveModal=function(feedItem){InstaAPI.getFeedItem(feedItem.id,function(res){console.log("getting individual feed item:, ",res),ko.mapping.fromJS(res,self.modal().activeModal),self.modal().activeModal.comments.data(res.comments.data),self.modal().active(!0),$("body").css("overflow","hidden"),self.modal().modalContainer.height();var relationship=$(".relationship"),id=res.user.id;insta.getRelationship(id,function(data){console.log(data),"follows"==data.data.outgoing_status?relationship.addClass("follows"):"none"==data.data.outgoing_status&&data.data.target_user_is_private===!0?relationship.addClass("followsNotPrivate"):"none"==data.data.outgoing_status&&data.data.target_user_is_private===!1&&relationship.addClass("followsNot")}),$(".comments").scrollTop($(".comments")[0].scrollHeight)})}}!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="https://platform.twitter.com/widgets.js",fjs.parentNode.insertBefore(js,fjs))}(document,"script","twitter-wjs"),jQuery.fn.autoGrow=function(){return this.each(function(){var a,c=function(b){a.innerHTML=b.value.replace(/\n/g,"<br/>")+".<br/>.",jQuery(b).height()!=jQuery(a).height()&&jQuery(b).height(jQuery(a).height())};jQuery(this).after('<div class="autogrow-textarea-mirror"></div>'),a=jQuery(this).next(".autogrow-textarea-mirror")[0],a.style.display="none",a.style.wordWrap="break-word",a.style.padding=jQuery(this).css("padding"),a.style.width=jQuery(this).css("width"),a.style.fontFamily=jQuery(this).css("font-family"),a.style.fontSize=jQuery(this).css("font-size"),a.style.lineHeight=jQuery(this).css("line-height"),this.style.overflow="hidden",this.style.minHeight=this.rows+"em",this.onkeyup=function(){c(this)},c(this)})};var bgPage=window.bgPage=chrome.extension.getBackgroundPage(),InstaAPI=window.InstaAPI=bgPage.InstaAPI,Data=window.Data=bgPage.Data;bgPage.console.log=function(){window.console.log("bg:",arguments)},ko.bindingHandlers.executeOnEnter={init:function(element,valueAccessor,allBindingsAccessor,viewModel){var allBindings=allBindingsAccessor(),context={},onlySubmitOnce=utils.debounce(function(){allBindings.executeOnEnter.call(viewModel,context)},2e3,!0);$(element).keypress(function(event){context=this;var keyCode=event.which?event.which:event.keyCode;return 13===keyCode?(onlySubmitOnce(),!1):!0})}};var mainViewModel=new AppViewModels;ko.applyBindings(mainViewModel);var showing=0,showInput=$("#searchDisplay"),hashTagLink=$(".caption a"),postCount=$("#post-count"),postCountNum=Data.get("_postCounts"),nextPage=localStorage.getItem("nextPage"),page=1,insta={buildFeed:function(feed){if(1===page&&(Data.isCacheValid(Data.StorageKeys.Feed)||Data.set(Data.StorageKeys.Feed,feed,6e4)),postCountNum=+postCountNum||20,feed){var feedData=feed.data||feed;if(1===page)mainViewModel.feedItems(feedData.slice(0,postCountNum));else for(var i=0;feedData&&feedData.length>i;i++)mainViewModel.feedItems.push(feedData[i]);var minRand=4,maxRand=10,ad="C6BDC",injectAd=function(min,max,ad){function Success(res){if(console.log(res),!res.ads[0].instagramId)return _gaq.push(["_trackEvent","ads","api no response",ad]),void 0;var adId=res.ads[0].instagramId,clickUrl=res.ads[0].statlink_default,clickId=clickUrl.substring(clickUrl.lastIndexOf("/")+1);InstaAPI.getFeedItem(adId,function(res){mainViewModel.feedItems.splice(pos,0,res),$("#picsList li").eq(pos).attr("data-clickid",clickId).addClass("featured"),_gaq.push(["_trackEvent","ads","api called",ad])})}function Error(response){console.log("calling error",response)}var rand=Math.random(),randSpan=rand*(max-min),floor=Math.floor(randSpan),pos=floor+min+20*(page-1);console.log("inject ad"),$.ajax({type:"get",url:"https://srv.buysellads.com/ads/"+ad+".json",success:Success,error:Error,dataType:"jsonp"})};InstaAPI.getAccessToken()&&(console.log("call ad injection"),injectAd(minRand,maxRand,ad),_gaq.push(["_trackEvent","ads","api called",ad]))}},buildUsers:function(list){mainViewModel.userFeedItems(list),$(".userResultsHldr").height()>=$(document).height()&&(console.log("results checked",list),$(".userResultsHldr").height($(document).height()-50))},userNameContainer:$("#userName"),buildUser:function(user){var info='<img class="avatar" src="'+user.profile_picture+'"/>'+'   <div class="name">'+user.username+"</div>";this.userNameContainer.html(info)},like:function(id,success){InstaAPI.apiCall({path:"/media/"+id+"/likes",ajaxType:"post",callback:function(data){(data.meta||200===data.meta.code)&&(console.log("like called:",data),Data.remove(Data.StorageKeys.Feed),success&&$.isFunction(success)&&success(data))}})},unlike:function(id,success){InstaAPI.apiCall({path:"/media/"+id+"/likes",ajaxType:"DELETE",callback:function(data){(data.meta||200===data.meta.code)&&(Data.remove(Data.StorageKeys.Feed),success&&$.isFunction(success)&&success(data)),Data.remove(Data.StorageKeys.Feed)}})},getTag:function(tag){InstaAPI.getTagFeed(tag,function(data){insta.buildFeed(data)})},getUserList:function(query){InstaAPI.searchUsers(query,function(data){insta.buildUsers(data)})},getRelationship:function(id,success){InstaAPI.apiCall({path:"/users/"+id+"/relationship",ajaxType:"get",callback:function(data){(data.meta||200===data.meta.code)&&success&&$.isFunction(success)&&success(data)}})},relationshipAction:function(userID,action){InstaAPI.relationshipAction(userID,action,function(){})}},ui={init:function(){Data.get("_searchValue"),InstaAPI.getAccessToken()&&($(".loginHldr, #settingsAuth").hide(),$("#userName").show(),$("#navigation .following").css("display","inline-block"),InstaAPI.getUser(function(res){insta.buildUser(res.data)})),ui.setFeed()},setFeed:function(from,page,forceRefresh){var curr=localStorage.getItem("current"),from=from||curr,page=page||1,next_id=localStorage.getItem("next_id");forceRefresh&&(console.log("Forcing refresh"),Data.set(Data.StorageKeys.Feed)),"popular"!==from&&InstaAPI.getAccessToken()?1===page?InstaAPI.getUserFeed(function(res){$("#navigation li.following").addClass("active"),res.pagination.next_max_id!==window.localStorage.getItem("next_id")&&(window.localStorage.setItem("next_id",res.pagination.next_max_id),insta.buildFeed(res.data))}):InstaAPI.addUserFeed(next_id,function(res){return console.log("next id:",next_id),"undefined"!==next_id&&next_id&&"null"!==next_id&&""!==next_id&&res.pagination.next_max_id!==window.localStorage.getItem("next_id")?(window.localStorage.setItem("next_id",res.pagination.next_max_id),insta.buildFeed(res.data),void 0):(console.log("caught dups"),void 0)}):(1===page&&$("#navigation li.popular").addClass("active"),InstaAPI.getPopularFeed(function(data){insta.buildFeed(data)}))}};$(function(){var from=localStorage.getItem("current");ui.init();var body=$("body"),picsList=body.find("#picsList"),navigation=(body.find("#modalOverlayContainer"),$("#navigation"));body.on("click",".heart",function(){var heartButton=$(this),id=$(this).attr("rel"),likeCountLabel=heartButton.siblings(".likeCount"),likeCount=+likeCountLabel.text();return InstaAPI.getAccessToken()?(heartButton.hasClass("liked")?insta.unlike(id,function(){heartButton.removeClass("liked"),likeCountLabel.html(likeCount--).removeClass("liked")}):insta.like(id,function(){heartButton.addClass("liked"),likeCountLabel.html(++likeCount).addClass("liked")}),void 0):(toastr.warning("Hey there shutterbug, why don't you login so you can like all the pictures"),void 0)}),picsList.on("hover","li",function(){var $this=$(this),captionContainer=$this.find(".caption");$this.hasClass("featured")&&_gaq.push(["_trackEvent","ads","hovered featured",$this.attr("data-mediaid")]),captionContainer.height()>75&&captionContainer.css("height",75),$this.find(".heart").addClass("activate"),setTimeout(function(){$this.find(".heart").removeClass("activate")},500)}),body.on("click",".account",function(){$(".settingsPop").fadeIn(250),picsList.addClass("blur"),$(".content").removeClass("out").addClass("in").show()}),body.on("click",".overlayBg",function(){$(".settingsPop").delay(150).fadeOut(250),picsList.removeClass("blur"),$(".content").removeClass("in").addClass("out").css({})}),body.on("hover",".modalContainer",function(){$("#newCommentInput").autoGrow()}),navigation.on("click","li",function(){var link=$(this),isPopLink="Popular"===link.text().trim();link.siblings().removeClass("active"),link.addClass("active"),$("html, body").animate({scrollTop:0},600),Data.set(Data.StorageKeys.Feed),isPopLink?(page=1,ui.setFeed("popular",page,!0),window.localStorage.setItem("current","popular")):(page=1,ui.setFeed("following",page,!0),window.localStorage.setItem("current","following"))}),addshots=setInterval(function(){a=$(document).height(),b=$(window).height(),c=$(window).scrollTop(),diff=b+c,diff>=a-805&&(from=localStorage.getItem("current"),_gaq.push(["_trackEvent","scoll",from,page]),page++,ui.setFeed(from,page))},1200),$(".authInsta").click(function(){InstaAPI.authorize()}),body.on("click",".featured .userDetails a.link",function(){var clickId=$(this).parent().parent(".featured").attr("data-clickid"),mediaid=$(this).parent().parent(".featured").attr("data-mediaid");console.log("clickId: "+clickId),_gaq.push(["_trackEvent","ads","clicked featured",mediaid]),$.ajax({type:"post",url:"https://srv.buysellads.com/ads/click/x/"+clickId,dataType:"jsonp"})}),body.on("click",".featured .userDetails .usersAvatar .relationship",function(){var clickId=$(this).parent().parent().parent(".featured").attr("data-clickid"),mediaid=$(this).parent().parent().parent(".featured").attr("data-mediaid");console.log("clickId: "+clickId),_gaq.push(["_trackEvent","ads","followed featured",mediaid]),$.ajax({type:"post",url:"https://srv.buysellads.com/ads/click/x/"+clickId,dataType:"jsonp"})}),body.on("click",".featured .heart",function(){var clickId=$(this).parent().parent(".featured").attr("data-clickid"),mediaid=$(this).parent().parent().parent(".featured").attr("data-mediaid");console.log("clickId Heart: "+clickId),_gaq.push(["_trackEvent","ads","liked featured",mediaid]),$.ajax({type:"post",url:"https://srv.buysellads.com/ads/click/x/"+clickId,dataType:"jsonp"})}),body.on("click",".modalOverlay",function(){var self=$(this);self.siblings(".modalContainer").addClass("out"),$("body").css("overflow","auto"),$(".modalOverlay").delay(150).fadeOut(250),setTimeout(function(){mainViewModel.modal().active(!1)},600)}),picsList.on("mouseenter",".usersAvatar",function(){var $this=$(this),id=$this.attr("rel");insta.getRelationship(id,function(data){"follows"==data.data.outgoing_status?$this.addClass("follows"):"none"==data.data.outgoing_status&&data.data.target_user_is_private===!0?$this.addClass("followsNotPrivate"):"none"==data.data.outgoing_status&&data.data.target_user_is_private===!1&&$this.addClass("followsNot")})}),$("body").on("click",".relationship",function(){var userID=mainViewModel.modal().activeModal.user.id(),$this=$(this),action="";console.log(userID),console.log($this),$this.hasClass("follows")?(action="unfollow",$this.removeClass("follows").addClass("followsNot"),insta.relationshipAction(userID,action)):$this.hasClass("followsNot")?(action="follow",$this.removeClass("followsNot").addClass("follows"),insta.relationshipAction(userID,action)):$this.hasClass("followsNotPrivate")&&(action="follow",$this.removeClass("followsNot").addClass("requested"),insta.relationshipAction(userID,action))})});